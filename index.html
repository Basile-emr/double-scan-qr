<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Double Scan QR â€” VÃ©rification rapide</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root{
      --accent:#2563eb;
    }
    body{font-family: Arial, system-ui, sans-serif; text-align:center; padding:20px;}
    h2{margin:0 0 6px}
    .sub{color:#666; font-size:13px; margin:0 0 14px}
    .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    button{padding:14px 20px; font-size:18px; border-radius:10px; border:1px solid #ddd; background:#fafafa;}
    button:active{transform:scale(0.99)}
    #reader{ width:340px; max-width:92vw; margin:14px auto; display:none; }
    #result{ font-size:22px; margin-top:12px; min-height:28px; }
    #last{ font-size:13px; color:#777; margin-top:8px; min-height:18px; }
    #tips{ font-size:12px; color:#666; margin-top:10px }
    select{ padding:8px; font-size:14px; border-radius:8px; border:1px solid #ddd; }
    .ok{ color: #16a34a }
    .err{ color: #dc2626 }
    .muted{ color: #6b7280 }
  </style>
</head>
<body>
  <h2>Double Scan QR</h2>
  <p class="sub">1) Scanner le document â†’ 2) Scanner le colis â†’ comparaison â†’ rÃ©initialisation automatique</p>

  <div class="row" style="margin-bottom:8px">
    <button id="btnDoc">ðŸ“„ Scanner QR Document</button>
    <button id="btnColis">ðŸ“¦ Scanner QR Colis</button>
    <button id="btnReset" title="RÃ©initialiser manuellement">â†º RÃ©initialiser</button>
  </div>

  <div class="row" style="align-items:center; gap:6px">
    <label for="cameraSelect" style="font-size:12px" aria-label="SÃ©lection de la camÃ©ra">CamÃ©ra :</label>
    <select id="cameraSelect"></select>
  </div>

  <div id="reader"></div>
  <div id="result" class="muted">PrÃªt pour un nouveau scan</div>
  <div id="last">Doc: â€”  |  Colis: â€”</div>
  <div id="tips">Astuce : ouvrez cette page en <b>HTTPS</b> et autorisez lâ€™accÃ¨s Ã  la camÃ©ra. Sur iPhone : utilisez Safari.</div>

  <script>
    let qrPapier = "";
    let qrColis = "";
    let resetting = false;
    const autoResetDelayMs = 1800;

    const readerEl = document.getElementById('reader');
    const resultEl = document.getElementById('result');
    const lastEl = document.getElementById('last');
    const cameraSelect = document.getElementById('cameraSelect');

    const html5QrCode = new Html5Qrcode('reader', { verbose: false });
    let currentCameraId = null;
    let isScanning = false;

    async function populateCameras(){
      try{
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = '';
        devices.forEach((d, i)=>{
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.label || `CamÃ©ra ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if(devices.length){
          const back = devices.find(d => /back|arriÃ¨re|rear|environment/i.test(d.label));
          cameraSelect.value = (back?.id) || devices[0].id;
          currentCameraId = cameraSelect.value;
        }
      }catch(e){
        console.warn('Impossible de lister les camÃ©ras', e);
      }
    }

    cameraSelect.addEventListener('change', ()=>{
      currentCameraId = cameraSelect.value;
      if(isScanning){
        stopScanner();
        startScanner(lastScanCallback);
      }
    });

    function normalize(s){
      if(!s) return '';
      return s.replace(/\s+/g,'').replace(/[\\\/|]/g,'-').toUpperCase();
    }

    function showLast(){
      const p = qrPapier ? ('Doc: '+qrPapier) : 'Doc: â€”';
      const c = qrColis ? ('Colis: '+qrColis) : 'Colis: â€”';
      lastEl.textContent = p + '  |  ' + c;
    }

    function setStatus(text, cls){
      resultEl.textContent = text;
      resultEl.className = cls || 'muted';
    }

    function checkMatch(){
      if(!qrPapier || !qrColis){
        setStatus('Scanne les deux QR', 'muted');
        return;
      }
      if(qrPapier === qrColis){
        setStatus('ðŸŸ¢ OK â€” Identiques', 'ok');
      }else{
        setStatus('ðŸ”´ Erreur â€” DiffÃ©rents', 'err');
      }
      scheduleAutoReset();
    }

    function scheduleAutoReset(){
      resetting = true;
      setTimeout(()=>{ resetAll(); resetting = false; }, autoResetDelayMs);
    }

    function resetAll(){
      qrPapier = '';
      qrColis = '';
      showLast();
      setStatus('PrÃªt pour un nouveau scan', 'muted');
    }

    let lastScanCallback = null;

    async function startScanner(callback){
      if(isScanning) return;
      lastScanCallback = callback;
      try{
        readerEl.style.display = 'block';
        isScanning = true;
        const config = { fps: 10, qrbox: 260, aspectRatio: 1.7778 };
        const cameraConfig = currentCameraId ? { deviceId: { exact: currentCameraId } } : { facingMode: { exact: 'environment' }};
        await html5QrCode.start(cameraConfig, config, onScanSuccess, onScanError);
      }catch(e){
        readerEl.style.display = 'none';
        isScanning = false;
        const isInsecure = location.protocol !== 'https:' && location.hostname !== 'localhost';
        const tip = isInsecure ? "\nAstuce : ouvrez le lien en HTTPS (ou en localhost)." : '';
        alert("Impossible d'accÃ©der Ã  la camÃ©ra. VÃ©rifiez les autorisations navigateur." + tip);
      }
    }

    async function stopScanner(){
      if(!isScanning) return;
      try{ await html5QrCode.stop(); }catch(e){}
      readerEl.style.display = 'none';
      isScanning = false;
    }

    function onScanSuccess(decodedText){
      stopScanner();
      if(typeof lastScanCallback === 'function'){
        lastScanCallback(decodedText.trim());
      }
    }
    function onScanError(_err){}

    document.getElementById('btnDoc').addEventListener('click', ()=>{
      if(resetting) return;
      startScanner((text)=>{ qrPapier = normalize(text); showLast(); checkMatch(); });
    });
    document.getElementById('btnColis').addEventListener('click', ()=>{
      if(resetting) return;
      startScanner((text)=>{ qrColis = normalize(text); showLast(); checkMatch(); });
    });
    document.getElementById('btnReset').addEventListener('click', resetAll);

    (async () => {
      await populateCameras();
      resetAll();
    })();
  </script>
</body>
</html>
