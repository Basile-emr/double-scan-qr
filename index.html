<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Double Scan QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  https://unpkg.com/html5-qrcode</script>
  <style>
    body { font-family: Arial, system-ui, sans-serif; text-align:center; padding:18px; }
    h2 { margin:6px 0 2px; }
    .sub { color:#666; font-size:13px; margin:0 0 10px; }
    button { padding: 14px 22px; font-size: 18px; margin: 8px; border-radius:10px; border:1px solid #ddd; background:#fafafa; }
    button:active { transform: scale(0.99); }
    #reader { width: 340px; max-width: 92vw; margin:14px auto; display:none; }
    #result { font-size: 22px; margin-top: 10px; min-height: 28px; }
    #last { font-size: 13px; color:#777; margin-top:6px; min-height:18px; }
    .hint { font-size:12px; color:#999; margin-top:8px; min-height:16px; }
  </style>
</head>
<body>
  <h2>Double Scan QR</h2>
  <p class="sub">1) Document â†’ 2) Colis â†’ comparaison â†’ rÃ©initialisation auto</p>

  <button onclick="scanPapier()">Scanner QR Document</button>
  <button onclick="scanColis()">Scanner QR Colis</button>
  <button onclick="resetAll()" title="RÃ©initialiser manuellement">â†º RÃ©initialiser</button>

  <div id="reader"></div>

  <div id="result"></div>
  <div id="last"></div>
  <div id="hint" class="hint"></div>

  <script>
    let qrPapier = "";
    let qrColis  = "";
    let autoResetDelayMs = 1800;
    let resetting = false;

    let html5QrCode = null;

    // Petit rappel pour iOS/HTTPS/permissions
    (function showHints(){
      const hint = document.getElementById('hint');
      const isHttps = location.protocol === 'https:';
      if (!isHttps) {
        hint.textContent = "Astuce : utilisez une URL HTTPS (GitHub Pages est OK) pour autoriser la camÃ©ra.";
      }
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        hint.textContent = "Sur iPhone : (1) lien HTTPS, (2) Safari hors navigation privÃ©e, (3) Autoriser CamÃ©ra pour ce site.";
      }
    })();

    async function strongStart(readerEl, onText) {
      // Essaye d'abord avec un deviceId de camÃ©ra arriÃ¨re si dispo, sinon fallback en facingMode.
      // 1) Tente d'Ã©numÃ©rer les camÃ©ras (dÃ©clenche souvent la permission)
      let cameraConfig = null;
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          // Choisit une camÃ©ra avec label "back" si possible, sinon la derniÃ¨re (souvent la back sur mobile)
          const back = devices.find(d => /back|rear|arriÃ¨re/i.test(d.label));
          const chosen = back || devices[devices.length - 1];
          cameraConfig = { deviceId: { exact: chosen.id } };
        }
      } catch(e) {
        // Pas grave, on tombera sur facingMode
      }

      // 2) CrÃ©e/Relance le lecteur
      if (html5QrCode) {
        try { await html5QrCode.stop(); } catch(_) {}
      }
      html5QrCode = new Html5Qrcode('reader');

      // 3) DÃ©marre avec config choisie, sinon fallback environment
      const cfg = { fps: 10, qrbox: 260 };
      const videoConfig = cameraConfig || { facingMode: "environment" };

      await html5QrCode.start(
        videoConfig,
        cfg,
        async (decodedText) => {
          try { await html5QrCode.stop(); } catch(_) {}
          readerEl.style.display = 'none';
          onText(decodedText.trim());
        },
        (_err) => { /* on ignore les erreurs de frames */ }
      );
    }

    async function startScanner(callback) {
      const readerEl = document.getElementById('reader');
      readerEl.style.display = 'block';

      try {
        await strongStart(readerEl, callback);
      } catch (e) {
        readerEl.style.display = 'none';
        alert("Impossible d'accÃ©der Ã  la camÃ©ra.\nâ€¢ VÃ©rifie que le site est en HTTPS\nâ€¢ Autorise la camÃ©ra pour ce site\nâ€¢ Sur iPhone, quitte la navigation privÃ©e.");
      }
    }

    function scanPapier() {
      if (resetting) return;
      startScanner((text) => {
        qrPapier = normalize(text);
        showLast();
        checkMatch();
      });
    }

    function scanColis() {
      if (resetting) return;
      startScanner((text) => {
        qrColis = normalize(text);
        showLast();
        checkMatch();
      });
    }

    function normalize(s) {
      return s.replace(/\s+/g,'').replace(/[\/\\]/g,'-').toUpperCase();
    }

    function checkMatch() {
      const res = document.getElementById('result');
      if (!qrPapier || !qrColis) {
        res.textContent = "Scanne les deux QR";
        res.style.color = "gray";
        return;
      }
      if (qrPapier === qrColis) {
        res.textContent = "ðŸŸ¢ OK â€” Identiques";
        res.style.color = "green";
      } else {
        res.textContent = "ðŸ”´ Erreur â€” DiffÃ©rents";
        res.style.color = "red";
      }
      scheduleAutoReset();
    }

    function scheduleAutoReset(){
      resetting = true;
      setTimeout(()=>{
        resetAll();
        resetting = false;
      }, autoResetDelayMs);
    }

    function resetAll(){
      const res = document.getElementById('result');
      qrPapier = '';
      qrColis  = '';
      res.textContent = 'PrÃªt pour un nouveau scan';
      res.style.color = 'gray';
      showLast();
    }

    function showLast(){
      const last = document.getElementById('last');
      const p = qrPapier ? ('Doc: ' + qrPapier) : 'Doc: â€”';
      const c = qrColis ? ('Colis: ' + qrColis) : 'Colis: â€”';
      last.textContent = p + '   |   ' + c;
    }

    // Ã‰tat initial
    resetAll();
  </script>
</body>
</html>
